<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설문조사 생성</title>
    <!-- 부트스트랩 CSS 링크 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="./survey_list.html">로고</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#">홈</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">서비스</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">포트폴리오</a>
            </li>
        </ul>
    </div>
</nav>

<main class="main_contents">
    <div class="container">
        <h1 class="text-center mb-4">새로운 설문조사 생성</h1>
        <form id="surveyForm">
            <div class="form-group">
                <label for="title">제목</label>
                <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="form-group">
                <label for="intro">소개</label>
                <textarea class="form-control" id="intro" name="intro" rows="3" required></textarea>
            </div>
            <div id="questionsContainer"></div>
            <button type="button" id="addQuestionBtn" class="btn btn-success">질문 추가</button>
            <button type="submit" class="btn btn-primary">생성하기</button>
        </form>
    </div>
</main>

<!-- 부트스트랩 JS 및 jQuery 링크 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Sortable 라이브러리 JS 링크 -->
<script src="http://SortableJS.github.io/Sortable/Sortable.js"></script>


<!-- 설문조사 생성 기능 스크립트 -->
<script>
    const BaseUrl = 'http://127.0.0.1:8000';
    const surveyForm = document.getElementById('surveyForm');
    const questionsContainer = document.getElementById('questionsContainer');
    const addQuestionBtn = document.getElementById('addQuestionBtn');

    let questionCounter = 1;

    Sortable.create(questionsContainer, {
        animation: 150, // 드래그 애니메이션 지속 시간 (밀리초)
    });

    addQuestionBtn.addEventListener('click', () => {
        const questionHtml = `
            <div class="question">
                <div class="form-group">
                    <label for="question_text">질문 내용</label>
                    <textarea class="form-control question_text" id="question_text" name="question_text" rows="2" required></textarea>
                </div>
                <div class="form-group">
                    <label for="question_type">질문 유형</label>
                    <select class="form-control question_type" id="question_type" name="question_type" required>
                        <option value="scale">객관식</option>
                        <option value="open">서술형</option>
                    </select>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input required" id="required" name="required">
                    <label class="form-check-label" for="required">필수</label>
                </div>
                <div id="answers_${questionCounter}">
                    <!-- 추가된 답변 필드가 여기에 동적으로 추가될 것입니다. -->
                </div>
            </div>
        `;
        const questionElement = document.createElement('div');
        questionElement.innerHTML = questionHtml;

        const addAnswerBtn = document.createElement('button');
        addAnswerBtn.innerHTML = '답변 추가';
        addAnswerBtn.className = 'btn btn-sm btn-secondary mt-2';
        questionElement.appendChild(addAnswerBtn);

        questionsContainer.appendChild(questionElement);

        let answerCounter = 1;

        const answersContainer = document.getElementById(`answers_${questionCounter}`);
        addAnswerBtn.addEventListener('click', () => {
            const answerHtml = `
                <div class="form-group">
                    <label for="answer_${questionCounter}_${answerCounter}">답변 내용</label>
                    <input type="text" class="form-control answers" id="answer" name="answer" required>
                </div>
            `;

            const answerElement = document.createElement('div');
            answerElement.innerHTML = answerHtml;
            answersContainer.appendChild(answerElement);

            answerCounter++;
        });

        questionCounter++;
    });
    
    // 폼 제출 시 서버로 데이터 전송
    // 폼 제출 이벤트 리스너
    surveyForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        try {
            // 질문 컨테이너 내의 질문 요소들을 선택
            const sortedQuestionElements = questionsContainer.querySelectorAll('.question');
            const questionsData = [];

            // 질문 데이터 수집
            sortedQuestionElements.forEach((questionElement, index) => {
                console.log(questionElement)
                const questionData = {
                    question_text: questionElement.querySelector('.question_text').value,
                    type: questionElement.querySelector('.question_type').value,
                    is_required: questionElement.querySelector('.required').checked,
                    qnum:index,
                    answers: [],
                };

                // 답변 데이터 수집
                const answerInputs = questionElement.querySelectorAll('.answers');
                console.log(answerInputs)
                answerInputs.forEach(answerInput => {
                    console.log(answerInput.value)
                    questionData.answers.push(answerInput.value);
                });

                questionsData.push(questionData);
            });

            // 폼 데이터 수집
            const formData = new FormData(surveyForm);
            
            // 포스트 데이터 생성
            const postData = {
                title: formData.get('title'),
                intro: formData.get('intro'),
                questions: questionsData,
            };

            // 서버로 데이터 전송
            const response = await fetch(BaseUrl + '/surveys/survey/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            });

            const data = await response.json();
            
            // 생성 완료 시 처리 로직 추가

        } catch (error) {
            console.error('Error creating survey:', error);
        }
    });

</script>
</body>
</html>
