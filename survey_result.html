<!DOCTYPE html>
<html>
<head>
    <title>Survey Result</title>
    <!-- 부트스트랩 CSS 링크 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- 사용자 정의 CSS -->
    <link rel="stylesheet" href="./css/style.css" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="./survey_list.html">로고</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">홈 <span class="sr-only">(현재 페이지)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">서비스</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">포트폴리오</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./survey_create.html">설문조사 생성</a> <!-- survey_create 버튼 -->
                </li>
            </ul>
        </div>
    </nav>
<main class="main_contents">
    <div class="container">
        <div class="d-flex justify-content-end mt-5">
            <a href="./survey_detail.html" class="btn btn-primary">답변 수정</a>
        </div>
        <div id="surveyResult" class="p-4 border rounded mt-2"></div>
    </div>
</main>
    <!-- 부트스트랩 JS 및 jQuery 링크 -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const currentUrl = window.location.href;

    // URL 파라미터 추출 함수
        function getParameterByName(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(currentUrl);
            
            if (!results) return null;
            if (!results[2]) return '';
            
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        const idParam = getParameterByName('id');

        const linkElement = document.querySelector('.btn-primary');
        const linkHref = linkElement.getAttribute('href');

        // 링크의 href 속성 업데이트
        linkElement.setAttribute('href', linkHref + '?id=' + idParam);

        const BaseUrl = 'http://127.0.0.1:8000';
        const surveyId = idParam;
        const surveyResultDiv = document.getElementById('surveyResult');

        fetch(BaseUrl+`/surveys/survey/result/${surveyId}`) // 위에서 등록한 URL로 요청을 보냅니다.
            .then(response => response.json()) // 응답 데이터를 JSON 형태로 파싱합니다.
            .then(data => {
                // Organize the data into a dictionary with questions as keys and arrays of answer counts as values
                const questionData = {};
                data.forEach(item => {
                    const questionText = item.question_text;
                    const answerText = item.answer_text;
                    const count = item.count;
                    
                    if (!questionData[questionText]) {
                        questionData[questionText] = [];
                    }
                    
                    questionData[questionText].push({ answerText, count });
                });

                // Loop through the questionData dictionary and create a chart for each question
                for (const questionText in questionData) {
                    const questionChartCanvas = document.createElement('canvas');
                    const questionChartDiv = document.createElement('div');

                    questionChartCanvas.className = 'mb-3';
                    questionChartDiv.className = 'mb-3';

                    questionChartDiv.appendChild(questionChartCanvas);
                    surveyResultDiv.appendChild(questionChartDiv);

                    const answerCounts = questionData[questionText];
                    const labels = answerCounts.map(item => item.answerText);
                    const counts = answerCounts.map(item => item.count);

                    const questionChart = new Chart(questionChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '답변 카운트',
                                data: counts,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    // 차트 위에 질문 텍스트를 제목으로 추가합니다.
                    const chartTitle = document.createElement('h3');
                    chartTitle.textContent = `질문: ${questionText}`;
                    questionChartDiv.insertBefore(chartTitle, questionChartCanvas);
                }

                // ... Rest of your JavaScript code ...
            })
            .catch(error => {
                console.error('Error:', error);
                surveyResultDiv.innerHTML = 'An error occurred while fetching data.';
            });
    </script>
</body>
</html>
